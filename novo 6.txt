var BASE_FIADOR = '../fes-web/servicos/contratofies/manutencaofiador';

window.ConsultaFiadorControle = Backbone.View.extend({

  urlTemplate: BASE_FIADOR + '/visao/ConsultaBaseFiador.html',

  // estado interno do front (pra excluir e re-renderizar)
  _fiadores: [],

  events: {
    "click a#btnLimpar": "limpar",
    "click a#btnConsultar": "consultar",
    "click a#btnVoltar": "voltar",
    "click a#btnLocalizarCodFies": "localizarCodFies",
    "click a#btnNovoFiador": "novoFiador",
    "click a#btnSair": "sair",
    "blur #formFiltroConsulta input": "change",
    "change #formFiltroConsulta select": "change",
    "blur #cpf": "validarCpf"
  },

  initialize: function () {
    var that = this;
    removerMensagens();

    // GARANTE execuÃ§Ã£o (nÃ£o use $.get para JS)
    $.getScript(BASE_FIADOR + '/modelo/Fiador.js');
    $.getScript(BASE_FIADOR + '/controle/FiadorControle.js');

    $.get(this.urlTemplate).done(function (data) {
      that.template = _.template(data);
      that.render();
      loadMask();
      removeAutoComplete('cpf', 'cpf');
    });
  },

  render: function () {
    $(this.el).html(this.template(this.model.toJSON()));
    $('#divResultado').hide();
    $('#tbResultadoFiadores tbody').empty();
    return this;
  },

  change: function (e) {
    var ch = {};
    ch[e.target.name] = e.target.value;
    this.model.set(ch);
  },

  validarCpf: function (e) {
    removerMensagens();
    var cpf = purificaAtributo(e.target.value);

    if (cpf !== '') {
      var msg = validarCPF(cpf);
      if (msg !== '') {
        mostrarErrors([{ message: msg }]);
        return false;
      }
    }
    return true;
  },

  limpar: function () {
    removerMensagens();
    limparFormulario('#formFiltroConsulta');
    if (this.model && this.model.initialize) this.model.initialize();

    this._fiadores = [];
    $('#divResultado').hide('slow');
    $('#tbResultadoFiadores tbody').empty();
  },

  validar: function () {
    if (!this.model.isValid()) {
      mostrarErrors(this.model.validationError);
      return false;
    }
    return true;
  },

  consultar: function () {
    var that = this;

    $('#divResultado').hide('slow');
    removerMensagens();
    this.model.set('cpf', purificaAtributo(this.model.get('cpf')));

    if (!this.validar()) return;

    $('#ajaxStatus').modal('show');

    this.model.buscar()
      .done(function (data) {
        if (data && data.mensagem) {
          $('#ajaxStatus').modal('hide');
          return mostrarErrors([{ message: data.mensagem }]);
        }

        // MOCK para testar visual
        if (!data) data = {};
        if (!data.fiadores && !data.listaFiadores) {
          data.fiadores = [
            { numeroContrato: '24.0340.185.0000061/47', cpfFiador: '00000000000', nomeFiador: 'CARLOS GAR', dataNascimento: '04/11/1999' },
            { numeroContrato: '19.0970.185.0003669/05', cpfFiador: '11111111111', nomeFiador: 'SIMONE FERREIRA', dataNascimento: '19/04/2011' }
          ];
        }

        that._fiadores = (data.fiadores || data.listaFiadores || []);
        that.renderTabelaFiadores(that._fiadores);

        $('#divResultado').show('slow');
        $('#ajaxStatus').modal('hide');
      })
      .fail(function () {
        that._fiadores = [
          { numeroContrato: '24.0340.185.0000061/47', cpfFiador: '00000000000', nomeFiador: 'CARLOS GAR', dataNascimento: '04/11/1999' }
        ];
        that.renderTabelaFiadores(that._fiadores);
        $('#divResultado').show('slow');
        $('#ajaxStatus').modal('hide');
      });
  },

  renderTabelaFiadores: function (fiadores) {
    var $tbody = $('#tbResultadoFiadores tbody');
    if ($tbody.length === 0) return;

    $tbody.empty();

    if (!fiadores || fiadores.length === 0) {
      $tbody.append('<tr><td colspan="5">Nenhum fiador encontrado.</td></tr>');
      return;
    }

    var that = this;

    _.each(fiadores, function (f, idx) {
      var tr =
        '<tr data-idx="' + idx + '">' +
        ' <td>' + (f.numeroContrato || f.nuContratoFormatado || '') + '</td>' +
        ' <td>' + (f.cpfFiador ? mascararCpf(f.cpfFiador) : '') + '</td>' +
        ' <td>' + (f.nomeFiador || f.noFiador || '') + '</td>' +
        ' <td>' + (f.dataNascimento || f.dtNascimento || '') + '</td>' +
        ' <td>' +
        '   <a href="#" class="btn btn-mini btn-primary btnAlterarFiadorRow">Alterar</a> ' +
        '   <a href="#" class="btn btn-mini btn-danger btnExcluirFiadorRow">Excluir</a>' +
        ' </td>' +
        '</tr>';

      var $tr = $(tr);

      $tr.find('.btnAlterarFiadorRow').click(function (e) {
        e.preventDefault();
        that.alterarFiador(f);
      });

      $tr.find('.btnExcluirFiadorRow').click(function (e) {
        e.preventDefault();
        that.excluirFiador(idx, f);
      });

      $tbody.append($tr);
    });
  },

  // âœ… Novo fiador (leva para tela de cadastro, nÃ£o modal)
  novoFiador: function (e) {
    if (e) e.preventDefault();
    removerMensagens();
    this._abrirCadastroFiador({ modo: 'incluir', fiadorRow: null });
  },

  // âœ… Alterar (leva para tela de cadastro com "modo alterar")
  alterarFiador: function (fiadorRow) {
    removerMensagens();
    this._abrirCadastroFiador({ modo: 'alterar', fiadorRow: fiadorRow });
  },

  // âœ… Excluir (confirma + remove da tabela â€” front testÃ¡vel)
  excluirFiador: function (idx, fiadorRow) {
    removerMensagens();

    var nome = (fiadorRow && (fiadorRow.nomeFiador || fiadorRow.noFiador)) ? (fiadorRow.nomeFiador || fiadorRow.noFiador) : 'o fiador';
    if (!confirm('Confirma excluir ' + nome + '?')) return;

    // Se tiver endpoint depois, vocÃª troca aqui por chamada backend.
    // Por enquanto remove da lista local:
    this._fiadores.splice(idx, 1);
    this.renderTabelaFiadores(this._fiadores);

    mensagemAlerta('Fiador excluÃ­do com sucesso.', 'OK');
  },

  // ðŸ”§ helper: abre a tela de cadastro carregando as dependÃªncias
  _abrirCadastroFiador: function (opts) {
    var modo = opts.modo; // incluir | alterar
    var fiadorRow = opts.fiadorRow;

    $.when(
      $.getScript(BASE_FIADOR + '/modelo/Fiador.js'),
      $.getScript(BASE_FIADOR + '/controle/FiadorControle.js'),
      $.getScript(BASE_FIADOR + '/controle/FiadorEnderecoListControle.js'),
      $.getScript(BASE_FIADOR + '/controle/FiadorContatoListControle.js'),
      $.getScript(BASE_FIADOR + '/controle/FiadorConjugeListControle.js')
    )
    .done(function () {

      // cria model com defaults do Fiador.js
      var modelFiador = new Fiador();

      // se for alteraÃ§Ã£o, prÃ©-popula o mÃ­nimo (se existir backend, aqui vocÃª faz fetch)
      if (modo === 'alterar' && fiadorRow) {
        if (fiadorRow.cpfFiador) modelFiador.set('cpf', fiadorRow.cpfFiador);
        if (fiadorRow.numeroContrato) modelFiador.set('numeroContrato', fiadorRow.numeroContrato);

        // se vocÃª tiver um endpoint de detalhe: modelFiador.fetch({data: ...}) e sÃ³ renderiza no done
      }

      $('#container').html(
        new FiadorControle({
          model: modelFiador,
          modo: modo,
          origem: 'consulta'
        }).el
      );
    })
    .fail(function () {
      alert('Erro ao carregar a tela de cadastro do fiador.');
    });
  },

  localizarCodFies: function () {
    $('#divResultado').hide();
    this.detalhe = new ConsultaGenericaEstudanteModalControle({
      el: $('#divModalIncluir'),
      model: new Estudante(),
      modelAnterior: this.model
    });
  },

  sair: function () { abrirPagina('../fes-web/fes-index.html'); },
  voltar: function () { abrirPagina('../fes-web/fes-index.html'); }

});

//# sourceURL=ConsultaFiadorControle.js



###############################

<div id="msgModal"></div>

<div class="tabbable" style="margin-bottom: 18px;">
  <ul class="nav nav-tabs">
    <li id="litab1" class="active">
      <a href="#tabDadosFiador" data-toggle="tab">Dados do Fiador</a>
    </li>
    <li id="litab2">
      <a href="#tabConjuge" data-toggle="tab">Dados do Conjuge</a>
    </li>
    <li id="litab3">
      <a href="#tabEndereco" data-toggle="tab">Endere&ccedil;o</a>
    </li>
    <li id="litab4">
      <a href="#tabContrato" data-toggle="tab">Contato</a>
    </li>
  </ul>

  <div class="tab-content" style="padding-bottom: 9px; border-bottom: 1px solid #ddd;">
    <div class="tab-pane active" id="tabDadosFiador"></div>
    <div class="tab-pane" id="tabConjuge"></div>
    <div class="tab-pane" id="tabEndereco"></div>
    <div class="tab-pane" id="tabContrato"></div>
  </div>
</div>



##############################################




var BASE_FIADOR = '../fes-web/servicos/contratofies/manutencaofiador';

window.FiadorModalControle = Backbone.View.extend({
  callback: null,
  modelFiador: null,

  initialize: function () {
    var that = this;
    removerMensagens();

    // clona o fiador recebido
    var cloneFiador = JSON.stringify(this.model.clone());
    this.modelFiador = new Fiador(JSON.parse(cloneFiador));

    $.when(
      $.getScript(BASE_FIADOR + '/controle/FiadorControle.js'),
      $.getScript(BASE_FIADOR + '/controle/FiadorConjugeControle.js'),
      $.getScript(BASE_FIADOR + '/controle/FiadorEnderecoControle.js'),
      $.getScript(BASE_FIADOR + '/controle/FiadorContatoControle.js')
    ).done(function () {

      $.get(BASE_FIADOR + '/visao/FiadorModal.html').done(function (data) {
        that.template = _.template(data);
        that.render();
      });

    }).fail(function () {
      console.error('FiadorModalControle: falha ao carregar controles das abas');
    });
  },

  render: function () {
    // IMPORTANTÃSSIMO: os IDs do HTML precisam bater com o FiadorModal.html corrigido
    $(this.el).html(this.template(this.modelFiador.toJSON()));

    var _this = this;

    $('#modalLabel').html("Dados do Fiador");
    $('#btnSalvar').html("Salvar mudan&ccedil;as");

    // Preenche panes (IDs do FiadorModal.html)
    $('#tabDadosFiador').html(new FiadorControle({ model: _this.modelFiador }).render().el);
    $('#tabConjuge').html(new FiadorConjugeControle({ model: _this.modelFiador }).render().el);
    $('#tabEndereco').html(new FiadorEnderecoControle({ model: _this.modelFiador }).render().el);
    $('#tabContrato').html(new FiadorContatoControle({ model: _this.modelFiador }).render().el);

    // Ajuste visual
    $('#modalBody legend').hide();

    $("#btnSalvar").unbind("click");
    $('#btnSalvar').click(function () {
      if (!_this.modelFiador.isValid()) {
        _this.mostrarErros(_this.modelFiador.validationError);
        $('#modalBody').animate({ scrollTop: 0 }, 500);
        return;
      }

      $("#btnSalvar").attr("disabled", "disabled");
      $('#ajaxStatus').modal('show');
      _this.salvar();
    });

    return this;
  },

  salvar: function () {
    var _this = this;

    this.modelFiador.salvar().done().success(function (data) {
      $("#btnSalvar").removeAttr("disabled");
      $('#ajaxStatus').modal('hide');

      if (data.codigo > 0) {
        _this.mostrarErros([{ name: data.codigo, message: data.mensagem }]);
        $('#modalBody').animate({ scrollTop: 0 }, 500);
      } else {
        _this.model.set(_this.modelFiador.toJSON());
        mensagemAlerta("Comando realizado com sucesso", "OK", function () {
          $('#modalBody').html("");
          $('#frmModal').modal('hide');
          if (_this.callback) _this.callback(_this.modelFiador);
        });
      }
    }).error(function () {
      $("#btnSalvar").removeAttr("disabled");
      $('#ajaxStatus').modal('hide');
      _this.mostrarErros([{ name: "1", message: "Ocorreu um erro na realizaÃ§Ã£o do comando, tente novamente!" }]);
      $('#modalBody').animate({ scrollTop: 0 }, 500);
    });
  },

  mostrarErros: function (errors) {
    var wMsg = '<div class="alert alert-error"><button type="button" class="close" data-dismiss="alert">x</button>';
    _.each(errors, function (error) {
      wMsg += error.message + "</BR>";
    });
    wMsg += '</div>';
    $('#msgModal').html(wMsg);
  }
});
