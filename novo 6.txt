<div id="msgModal"></div>

<div class="tabbable" style="margin-bottom: 18px;">
  <ul class="nav nav-tabs">
    <li id="litab1" class="active"><a href="#tabFiador1" data-toggle="tab">Dados do Fiador</a></li>
    <li id="litab2"><a href="#tabFiador2" data-toggle="tab">Dados do Cônjuge</a></li>
    <li id="litab3"><a href="#tabFiador3" data-toggle="tab">Endereço</a></li>
    <li id="litab4"><a href="#tabFiador4" data-toggle="tab">Contato</a></li>
  </ul>

  <div class="tab-content" style="padding-bottom: 9px; border-bottom: 1px solid #ddd;">
    <!-- ✅ containers vazios, sem placeholder -->
    <div class="tab-pane active" id="tabFiador1">
      <div id="tabDadosFiador"></div>
    </div>

    <div class="tab-pane" id="tabFiador2">
      <div id="tabConjuge"></div>
    </div>

    <div class="tab-pane" id="tabFiador3">
      <div id="tabEndereco"></div>
    </div>

    <div class="tab-pane" id="tabFiador4">
      <div id="tabContato"></div>
    </div>
  </div>
</div>



#####################################

var BASE_FIADOR = '../fes-web/servicos/contratofies/manutencaofiador';

window.FiadorModalControle = Backbone.View.extend({
  callback: null,
  modelFiador: null,

  initialize: function () {
    var that = this;
    removerMensagens();

    // clone do fiador (mantém sua lógica)
    var cloneFiador = JSON.stringify(this.model.clone());
    this.modelFiador = new Fiador(JSON.parse(cloneFiador));

    // ✅ IMPORTANTE: carregar controllers como SCRIPT
    $.when(
      $.getScript(BASE_FIADOR + '/controle/FiadorControle.js'),
      $.getScript(BASE_FIADOR + '/controle/FiadorConjugeControle.js'),
      $.getScript(BASE_FIADOR + '/controle/FiadorEnderecoControle.js'),
      $.getScript(BASE_FIADOR + '/controle/FiadorContatoControle.js')
    )
    .done(function () {
      $.get(BASE_FIADOR + '/visao/FiadorModal.html')
        .done(function (data) {
          that.template = _.template(data);
          that.render();
        })
        .fail(function (xhr) {
          console.error('[FiadorModalControle] Falha ao carregar FiadorModal.html', xhr && xhr.status);
        });
    })
    .fail(function (xhr, status, err) {
      console.error('[FiadorModalControle] Falha ao carregar controles', status, err);
    });
  },

  render: function () {
    // template não precisa de variáveis, ok
    $(this.el).html(this.template({}));
    var _this = this;

    $('#modalLabel').html("Dados do Fiador");
    $('#btnSalvar').html("Salvar mudan&ccedil;as");

    // ✅ injeta cada tela no container certo
    $('#tabDadosFiador').empty().append(new FiadorControle({ model: _this.modelFiador }).el);
    $('#tabConjuge').empty().append(new FiadorConjugeControle({ model: _this.modelFiador }).el);
    $('#tabEndereco').empty().append(new FiadorEnderecoControle({ model: _this.modelFiador }).el);
    $('#tabContato').empty().append(new FiadorContatoControle({ model: _this.modelFiador }).el);

    // ⚠️ Alguns controles só montam conteúdo em render(). Se eles tiverem render(), chama:
    try { if (typeof $('#tabDadosFiador').children().data === 'function') {} } catch(e){}
    if (typeof _this.modelFiador !== 'undefined') {
      if (typeof FiadorControle !== 'undefined' && FiadorControle.prototype && FiadorControle.prototype.render) {
        $('#tabDadosFiador').html(new FiadorControle({ model: _this.modelFiador }).render().el);
      }
      if (typeof FiadorConjugeControle !== 'undefined' && FiadorConjugeControle.prototype && FiadorConjugeControle.prototype.render) {
        $('#tabConjuge').html(new FiadorConjugeControle({ model: _this.modelFiador }).render().el);
      }
      if (typeof FiadorEnderecoControle !== 'undefined' && FiadorEnderecoControle.prototype && FiadorEnderecoControle.prototype.render) {
        $('#tabEndereco').html(new FiadorEnderecoControle({ model: _this.modelFiador }).render().el);
      }
      if (typeof FiadorContatoControle !== 'undefined' && FiadorContatoControle.prototype && FiadorContatoControle.prototype.render) {
        $('#tabContato').html(new FiadorContatoControle({ model: _this.modelFiador }).render().el);
      }
    }

    // ✅ ativa aba 1 corretamente (IDs existem agora)
    $('#tabFiador1').addClass('active');
    $('#tabFiador2,#tabFiador3,#tabFiador4').removeClass('active');
    $('#litab1').addClass('active');
    $('#litab2,#litab3,#litab4').removeClass('active');

    // Ajuste visual (mantido)
    $('#modalBody legend').hide();

    // salva
    $("#btnSalvar").off("click").on("click", function () {
      if (!_this.modelFiador.isValid()) {
        _this.mostrarErros(_this.modelFiador.validationError);
        $('#modalBody').animate({ scrollTop: 0 }, 500);
        return;
      }
      $("#btnSalvar").attr("disabled", "disabled");
      $('#ajaxStatus').modal('show');
      _this.salvar();
    });

    return this;
  },

  salvar: function () {
    var _this = this;

    this.modelFiador.salvar()
      .done(function (data) {
        $("#btnSalvar").removeAttr("disabled");
        $('#ajaxStatus').modal('hide');

        if (data && data.codigo > 0) {
          var errors = [{ name: data.codigo, message: data.mensagem }];
          _this.mostrarErros(errors);
          $('#modalBody').animate({ scrollTop: 0 }, 500);
        } else {
          _this.model.set(_this.modelFiador.toJSON());
          mensagemAlerta("Comando realizado com sucesso", "OK", function () {
            $('#modalBody').html("");
            $('#frmModal').modal('hide');
            if (_this.callback) _this.callback(_this.modelFiador);
          });
        }
      })
      .fail(function () {
        $("#btnSalvar").removeAttr("disabled");
        $('#ajaxStatus').modal('hide');
        _this.mostrarErros([{ name: "1", message: "Ocorreu um erro na realização do comando, tente novamente!" }]);
        $('#modalBody').animate({ scrollTop: 0 }, 500);
      });
  },

  mostrarErros: function (errors) {
    var wMsg = '<div class="alert alert-error"><button type="button" class="close" data-dismiss="alert">x</button>';
    _.each(errors || [], function (error) {
      wMsg += (error.message || '') + "</BR>";
    });
    wMsg += '</div>';
    $('#msgModal').html(wMsg);
  }
});



#####################################
